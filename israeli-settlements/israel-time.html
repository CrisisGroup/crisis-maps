<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Map of Israeli Settlements and Outposts</title>
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.css" rel="stylesheet" />
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://use.typekit.net/nqh8ygh.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>

    <div class="legend">
        <div class="legend-header">LEGEND</div>
        <p><i style="background-color: #165c7d; border: solid 0.5px #fff;"></i>Settlements</p>
        <p><i style="background-color: #9a4343; border: solid 0.5px #fff;"></i>Outposts</p>
        <p><i style="background-color: #fff; border: solid 0.5px black;"></i>Other Outposts</p>
        <hr />
        <p><i style="background-color: #beb8b3; border-radius: 0;"></i>Controlled or partly controlled by Palestinian Authorities</p>
    </div>
    <div class="slider-container">
        <h1>Israeli Settlement and Outpost Expansion in the West Bank</h1>
        <label for="year-slider">
            <h2>BY YEAR &nbsp;&nbsp;<span id="selected-year">1967</span></h2>
        </label>
        <input id="year-slider" type="range" min="1967" max="2020" step="1" value="1967"
            oninput="document.getElementById('selected-year').textContent = this.value">
    </div>

    <div id='map'></div>
    <script>

        document.addEventListener('DOMContentLoaded', function () {
            const range = document.getElementById('year-slider');
            const updateSlider = () => {
                const value = ((range.value - range.min) / (range.max - range.min) * 100);
                range.style.setProperty('--thumb-percentage', `${value}%`);
            };

            range.addEventListener('input', updateSlider);
            updateSlider();
        });

        function scroolZoomEnable() {
            const width = window.innerWidth;
            if (width < 1024) {
                return false; // Disable scrollwheel on smaller devices
            } else {
                return true; // Enable it
            }
        }

        mapboxgl.accessToken = 'pk.eyJ1IjoiZGFsdG9ud2IiLCJhIjoiOWdSSXFQSSJ9.HZyjh4g3TAAOAncwelv9Vw';
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/daltonwb/cm0gwbjwg002w01pieauqhlys',
            center: [35.030781, 31.891362],
            zoom: 8,
            maxZoom: 14,
            minZoom: 7.5,
            showZoom: true,
            scrollZoom: scroolZoomEnable(),
            maxBounds: [[33.40434, 30.92008], [37.29292, 32.89675]],
            attributionControl: false
        });

        map.addControl(new mapboxgl.NavigationControl());
        map.addControl(new mapboxgl.FullscreenControl());
        map.addControl(new mapboxgl.AttributionControl({
            customAttribution: 'International Crisis Group | Map by <a href="https://www.linkedin.com/in/pkfranz" target="_blank">Paul Franz</a> and Claire Boccon-Gibod | Data: <a href="https://peacenow.org.il/en/settlements-watch/settlements-data/population" target="_blank">PeaceNow</a>'
        }));


        map.on('load', function () {
            map.addSource('settlements', {
                type: 'vector',
                url: 'mapbox://daltonwb.b5xx5phj'
            });

            var initialYear = 1967;

            // Existing setup for Settlements and Outposts
            // Settlements layer
            map.addLayer({
                "id": "settlements-layer-settlement",
                "type": "circle",
                "source": "composite",
                "source-layer": "IL_PA_Settlements_-_il_settle-69skx2",
                "filter": [
                    "all",
                    ["<=", ["get", "year"], initialYear],
                    ["match", ["get", "type"], ["Settlement"], true, false]
                ],
                "paint": {
                    "circle-color": "#6399ae",
                    "circle-stroke-color": "#ffffff",
                    "circle-stroke-width": 0.5
                }
            });

            // Outposts layer
            map.addLayer({
                "id": "settlements-layer-outpost",
                "type": "circle",
                "source": "composite",
                "source-layer": "IL_PA_Settlements_-_il_settle-69skx2",
                "filter": [
                    "all",
                    ["<=", ["get", "year"], initialYear],
                    ["match", ["get", "type"], ["Outpost"], true, false]
                ],
                "paint": {
                    "circle-color": "#a4343a",
                    "circle-stroke-color": "#ffffff",
                    "circle-stroke-width": 0.5
                }
            });

            // Additional layer for stroke-only visibility that honors the time slider
            map.addLayer({
                "id": "il-pa-settlements-il-settle-69skx2-stroke",
                "type": "circle",
                "source": "composite",
                "source-layer": "IL_PA_Settlements_-_il_settle-69skx2",
                "filter": [
                    "all",
                    ["<=", ["get", "year"], initialYear],
                    ["match", ["get", "type"], ["Settlement", "Outpost"], false, true]
                ],
                "paint": {
                    "circle-color": "rgba(0, 0, 0, 0)", // No fill color
                    "circle-stroke-color": "#000000",   // Black stroke
                    "circle-stroke-width": 0.5
                }
            });

            // Slider updates
            document.getElementById('year-slider').addEventListener('input', function (e) {
                var year = parseInt(e.target.value, 10);
                // Update filters for all layers to reflect changes up to the selected year
                map.setFilter('settlements-layer-settlement', ["all", ["<=", ["get", "year"], year], ["match", ["get", "type"], ["Settlement"], true, false]]);
                map.setFilter('settlements-layer-outpost', ["all", ["<=", ["get", "year"], year], ["match", ["get", "type"], ["Outpost"], true, false]]);
                map.setFilter('il-pa-settlements-il-settle-69skx2-stroke', ["all", ["<=", ["get", "year"], year], ["match", ["get", "type"], ["Settlement", "Outpost"], false, true]]);
            });
        });
    </script>
</body>

</html>